<?xml version="1.0" encoding="UTF-8"?>
<project name="Glucose" default="phpdoc" basedir=".">
	<taskdef name="mysqli-connect" classname="Phing.ConnectMySQLiTask" />
	<taskdef name="countlines" classname="Phing.CountLinesTask" />
	
	<property file="build.properties" />
	
	<target name="eclipse">
		<phingcall target="phpunit" />
	</target>
	
	<target name="phpdoc">
		<delete dir="${docs.dir}" />
		<phpdoc title="Glucose Framework Documentation"
			destdir="${docs.dir}" sourcecode="no"
			output="HTML:Smarty:PHP" defaultpackagename = "model"
			undocumentedelements = "true">
			<fileset dir="Glucose">
				<include name="*.class.php" />
			</fileset>
		</phpdoc>
	</target>
	
	<target name="countlines">
		<countlines dir="${project.basedir}" extensions=".php" />
	</target>
	
	<target name="phplint">
		<phplint>
		  <fileset dir="${src.dir}">
		    <include name="**/*.class.php"/>
		  </fileset>
		</phplint>
	</target>

	<target name="phpcs">
		<phpcodesniffer standard="PEAR" showSniffs="true">
			<formatter outfile="${reports.phpcs.txt}" type="summary"/>
			<fileset dir="${src.dir}">
				<include name="**/*.class.php"/>
			</fileset>
		</phpcodesniffer>
	</target>

	<target name="phpunit" depends="autoloader">
		<delete dir="${reports.phpunit.dir}" />
		<mkdir dir="${reports.phpunit.dir}" />
		<pdo url="mysql:host=${mysql.hostname}" src="${tests.sqlscript}"
			userid="${mysql.username}" password="${mysql.password}" />
		<mysqli-connect
			host="${mysql.hostname}" schema="${tests.schema}"
			user="${mysql.username}" pass="${mysql.password}" />
		<adhoc>
			<![CDATA[ Glucose\Model::connect($GLOBALS['mysqli']); ]]>
		</adhoc>
		
		<phpunit>
			<formatter todir="${reports.phpunit.dir}" outfile="${reports.phpunit.xml}" type="xml" />
			<batchtest>
				<fileset dir="${tests.dir}">
					<include name="*/*Test.php" />
				</fileset>
			</batchtest>
		</phpunit>
		<phpunitreport infile="${reports.phpunit.dir}/${reports.phpunit.xml}"
			format="frames" todir="${reports.phpunit.dir}"/>
	</target>
	
	<target name="coverage" depends="autoloader">
		<delete dir="${reports.coverage.dir}" />
		<mkdir dir="${reports.coverage.dir}" />
		<pdo url="mysql:host=${mysql.hostname}" src="${tests.sqlscript}"
			userid="${mysql.username}" password="${mysql.password}" />
		<mysqli-connect
			host="${mysql.hostname}" schema="${tests.schema}"
			user="${mysql.username}" pass="${mysql.password}" />
		<adhoc>
			<![CDATA[ Glucose\Model::connect($GLOBALS['mysqli']); ]]>
		</adhoc>
		<coverage-setup database="${reports.coverage.dir}/${reports.coverage.db}">
			<fileset dir="${src.dir}">
				<include name="**.class.php"/>
			</fileset>
		</coverage-setup>
		<phpunit codecoverage="true">
			<batchtest>
			<fileset dir="${tests.dir}">
				<include name="*/*Test.php"/>
			</fileset>
			</batchtest>
		</phpunit>
		<coverage-report outfile="${reports.coverage.dir}/${reports.coverage.xml}">
			<report todir="${reports.coverage.dir}" styledir="${reports.coverage.stylesdir}"/>
		</coverage-report>
	</target>
	
	<target name="autoloader" description="Initializes the autoloader">
		<adhoc>
			<![CDATA[ function __autoload($class) { require_once(str_replace('\\', '/', $class).'.class.php'); } ]]>
		</adhoc>
	</target>
</project>